---
name: Bundle and Deploy EAS Update

on:
  workflow_dispatch:
    inputs:
      runtimeVersion:
        type: string
        description: Runtime version (in x.x.x format) that this update is for
        required: true

jobs:
  bundleDeploy:
    name: Bundle and Deploy EAS Update
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§ Validate version
        run: |
          [[ "${{ github.event.inputs.runtimeVersion }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] && echo "Version is valid" || exit 1

      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: yarn

      - name: âš™ï¸ Install Dependencies
        run: yarn install

      - name: ğŸª› Install jq
        uses: dcarbone/install-jq-action@v2

      - name: â›ï¸ Setup Expo
        run: yarn global add eas-cli-local-build-plugin

      - name: ğŸ”¤ Compile Translations
        run: yarn intl:build

      - name: âœï¸ Write environment variables
        run: |
          export json='${{ secrets.GOOGLE_SERVICES_TOKEN }}'
          echo "${{ secrets.ENV_TOKEN }}" > .env
          echo "$json" > google-services.json

      - name: ğŸ—ï¸ Create Bundle
        run: yarn export

      - name: ğŸ“¦ Package Bundle and ğŸš€ Deploy
        run: yarn make-deploy-bundle
        env:
          DENIS_API_KEY: ${{ secrets.DENIS_API_KEY }}
          RUNTIME_VERSION: ${{ github.event.inputs.runtimeVersion }}
