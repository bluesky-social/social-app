name: 'Build Translations'
description: 'Compile translations with caching and optionally check for errors'
inputs:
  check-for-errors:
    description: 'Whether to check for i18n compilation errors'
    required: false
    default: 'false'
runs:
  using: 'composite'
  steps:
    - name: ðŸ“ Extract all translation strings
      shell: bash
      run: yarn intl:extract:all

    - name: ðŸ”‘ Generate cache key
      id: cache-key
      shell: bash
      env:
        PO_HASH: ${{ hashFiles('src/locale/locales/**/messages.po') }}
      run: |
        # Get @lingui/cli version to bust cache on compiler upgrades
        LINGUI_VERSION=$(grep '"version"' node_modules/@lingui/cli/package.json | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')
        CACHE_KEY="translations-${PO_HASH}-lingui-${LINGUI_VERSION}"
        echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
        echo "Cache key: ${CACHE_KEY}"

    - name: ðŸ“¦ Restore translations cache
      id: cache-translations
      uses: actions/cache@v4
      with:
        path: src/locale/locales/*/messages.js
        key: ${{ steps.cache-key.outputs.key }}

    - name: ðŸ”¤ Compile translations
      if: steps.cache-translations.outputs.cache-hit != 'true'
      shell: bash
      run: yarn intl:compile 2>&1 | tee i18n.log

    - name: Check for i18n compilation errors
      if: inputs.check-for-errors == 'true' && steps.cache-translations.outputs.cache-hit != 'true'
      shell: bash
      run: |
        if grep -q "invalid syntax" "i18n.log"; then
          echo -e "\n\nFound compilation errors!\n\n"
          exit 1
        else
          echo -e "\n\nNo compilation errors!\n\n"
        fi
